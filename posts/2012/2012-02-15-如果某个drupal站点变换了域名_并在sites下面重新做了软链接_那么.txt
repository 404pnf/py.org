# 如果某个drupal站点变换了域名 并在sites下面重新做了软链接 那么有时会出现registry报错的问题

比如我有几个站点出现下面错误 报错说有注册表数据库有冲突。我查看了。报错的那条数据在数据表中只有一条，不会出现duplicate entry。 但总是报这个错误。 今天突然想到了。之前这个站点叫 a.example.com，后来改域名为 b.example.com了。我呢，就直接做了一个软链接从 sites/b.exmaple.com 到 sites/a.example.com 。对于drupal来说，当访问b.example.com的时候，会访问对应的sites/b.example.com目录，drupal根本不会知道 sites/a.example.com这个目录。因此不会是软链接造成的。 那么冲突从何而来。 答案是： 在registry表中，drupal用name和class做主键，主键是不能重复的。 如果你仔细观察我下面的错误信息和解决办法。你会发现我停了报duplicate key的模块，然后再启用，就解决了。 这是因为，当我站点还运行在a.example.com的时候，我启用了feeds模块。这时FeedsCSVParser在注册表中的信息是 [:db\_insert\_placeholder\_0] => FeedsCSVParser [:db\_insert\_placeholder\_1] => class [:db\_insert\_placeholder\_2] => sites/a.example.com/modules/standard/feeds/plugins/FeedsCSVParser.inc [:db\_insert\_placeholder\_3] => feeds [:db\_insert\_placeholder\_4] => 0 ) 一定要注意第3行。此时写入地址是 a.example.com 目录。 好，后来我前换站点到了b.example.com，此时刷新drupal，它会去 sites/b.exmaple.com/modules 下找模块，这时，它也找到了FeedsCSVParser这个模块，准备往数据库里写的时候，突然发现，已经有这条数据了，而且是有效的，因为a.example.com目录也存在。如果再写，会重复（duplicate）。我们之前说了，drupal用 name 和 class 做联合主键，因此虽然filename参数不同，但确实重复了。所以，每次清缓存，drupal会重新扫描模块，都会发现这个冲突。因此一直报错。 停了模块再启用的时候，drupal就会直接用新扫描上来的数据替换之前的，之后也不会再报冲突了。 但此时数据库中的filename项更新了么？没有！！ 要想更新，必须停用并且卸载该模块然后重新启用！！ 所以，卸载模块再重新启用才是解决问题的关键！ 你应该把feeds的参数导成features了吧。否则你可累了：） > $ drush @de cc all > 'all' cache was cleared [success] > example@wuxiekeji:~$ drush @de cc all > WD registry: PDOException: SQLSTATE[23000]: Integrity constraint violation: [error] > 1062 Duplicate entry 'FeedsCSVParser-class' for key 'PRIMARY': INSERT INTO > {registry} (name, type, filename, module, weight) VALUES > (:db\_insert\_placeholder\_0, :db\_insert\_placeholder\_1, :db\_insert\_placeholder\_2, > :db\_insert\_placeholder\_3, :db\_insert\_placeholder\_4); Array > ( > [:db\_insert\_placeholder\_0] => FeedsCSVParser > [:db\_insert\_placeholder\_1] => class > [:db\_insert\_placeholder\_2] => > sites/de.mlp.example.com/modules/standard/feeds/plugins/FeedsCSVParser.inc > [:db\_insert\_placeholder\_3] => feeds > [:db\_insert\_placeholder\_4] => 0 > ) > in \_registry\_parse\_file() (line 179 of > /var/www/d7production/includes/registry.inc). > > > example@wuxiekeji:~$ drush @de dis feeds > The following extensions will be disabled: feeds, feeds\_import, feeds\_tamper, feeds\_tamper\_ui, feeds\_ui, sites\_integration\_features\_all > Do you really want to continue? (y/n): y > feeds was disabled successfully. [ok] > feeds\_import was disabled successfully. [ok] > feeds\_tamper was disabled successfully. [ok] > feeds\_tamper\_ui was disabled successfully. [ok] > feeds\_ui was disabled successfully. [ok] > sites\_integration\_features\_all was disabled successfully. [ok] > example@wuxiekeji:~$ drush @de cc all > 'all' cache was cleared [success] > example@wuxiekeji:~$ drush @de en feeds, feeds\_import, feeds\_tamper, feeds\_tamper\_ui, feeds\_ui, sites\_integration\_features\_all > The following extensions will be enabled: feeds, feeds\_import, feeds\_tamper, feeds\_tamper\_ui, feeds\_ui, sites\_integration\_features\_all > Do you really want to continue? (y/n): y > feeds\_import was enabled successfully. [ok] > feeds\_tamper was enabled successfully. [ok] > feeds\_tamper\_ui was enabled successfully. [ok] > feeds\_ui was enabled successfully. [ok] > sites\_integration\_features\_all was enabled successfully. [ok] > feeds was enabled successfully. [ok] > example@wuxiekeji:~$ drush @de cc all > 'all' cache was cleared

2012-02-15